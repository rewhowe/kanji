const APP_KEY="search_kanji",LOCAL_STORAGE_AVAILABLE=(()=>{try{return!!localStorage}catch(n){return!1}})();function getJson(n,t){LOCAL_STORAGE_AVAILABLE&&localStorage[n]?t(JSON.parse(localStorage[n])):axios.get(n).then(function(e){LOCAL_STORAGE_AVAILABLE&&(localStorage[n]=JSON.stringify(e.data)),t(e.data)})}function intersect(n,t){return n.filter(n=>t.includes(n))}const LOOKALIKES={"-":["一"],"ー":["一"],"^":["个"],"＾":["个"],J:["亅"],"Ｊ":["亅"],"ル":["儿"],"リ":["刈"],"カ":["力"],"ヒ":["匕"],"イ":["化"],"+":["十"],"＋":["十"],"ト":["卜"],"ム":["厶"],"囗":["囗","口"],"口":["囗","口"],"ロ":["囗","口"],"土":["土","士"],"士":["土","士"],"エ":["工"],"日":["日","曰"],"毋":["毋","母"],"母":["毋","母"],"ネ":["礼","初"],B:["邦","阡"],"Ｂ":["邦","阡"],"|":["｜"]},RADK={"⺅":"化","𠆢":"个","丷":"并","⺉":"刈","𠂉":"乞","⻌":"込","⺌":"尚","⺖":"忙","⺘":"扎","⺡":"汁","⺨":"犯","⺾":"艾","⻏":"邦","⻖":"阡","⺹":"老","⺣":"杰","⺭":"礼","疒":"疔","禸":"禹","⻂":"初","⺲":"買","啇":"滴"},RADK_DISPLAY={};Object.keys(RADK).forEach(function(n){RADK_DISPLAY[RADK[n]]=n});const ALTERNATE_FORMS={"人":"⺅","八":"丷","氷":"冫","刀":"⺉","小":"⺌","川":"巛","心":"⺖","手":"⺘","水":"⺡","火":"⺣","犬":"⺨","草":"⺾"},STROKE_ORDER_JSON_URL="https://rewhowe.github.io/kanji/public/json/stroke_order.json",FREQ_JA_ORDER_JSON_URL="https://rewhowe.github.io/kanji/public/json/freq_ja_order.json",FREQ_CN_ORDER_JSON_URL="https://rewhowe.github.io/kanji/public/json/freq_cn_order.json",SORT_OPTIONS={stroke:"画数",freq_ja:"日本語での使用頻度",freq_cn:"中国語での使用頻度"};function sortBy(n,t,e){let i;"stroke"==t?i=STROKE_ORDER_JSON_URL:"freq_ja"==t?i=FREQ_JA_ORDER_JSON_URL:"freq_cn"==t&&(i=FREQ_CN_ORDER_JSON_URL),getJson(i,function(t){n.sort(function(n,e){return(t[n]||1/0)-(t[e]||1/0)}),e(n)})}Vue.component("about-section",{template:'\n    <section class="about">\n      <h2 class="about-title">このアプリについて</h2>\n\n      <div class="help-sections">\n        <div class="help-section">\n          <p class="help-text"><i class="far fa-eye"></i>のボタンを押すと、入力の文字に似てる部首を検索出来ます。検索対象になった似た部首には<i class="far fa-eye"></i>のアイコンが付きます。</p>\n          <table class="help-input-chart">\n            <thead>\n              <tr>\n                <th class="help-input-chart_header">入力</th>\n                <th class="help-input-chart_header">検索対象</th>\n              </tr>\n            </thead>\n            <tbody>\n              <tr v-for="(input, search_radicals) in similar_input_chart">\n                <td>{{ input }}</td>\n                <td>{{ search_radicals }}</td>\n              </tr>\n            </tbody>\n          </table>\n        </div>\n\n        <div class="help-section">\n          <p class="help-text">特定の文字の前に！を入力すると変形に変換されます。</p>\n          <table class="help-input-chart">\n            <thead>\n              <tr>\n                <th class="help-input-chart_header">入力</th>\n                <th class="help-input-chart_header">変形</th>\n              </tr>\n            </thead>\n            <tbody>\n              <tr v-for="(variant, input) in variant_input_chart">\n                <td>！{{ input }}</td>\n                <td>{{ variant }}</td>\n              </tr>\n            </tbody>\n          </table>\n        </div>\n      </div>\n    </section>\n  ',computed:{similar_input_chart:function(){const n={};return Object.keys(LOOKALIKES).forEach(function(t){const e=LOOKALIKES[t].map(function(n){return RADK_DISPLAY[n]||n}).join(" ");n[e]?n[e]+=" or "+t:n[e]=t}),n},variant_input_chart:function(){return ALTERNATE_FORMS}}}),Vue.component("candidate-list",{props:{searching:Boolean,candidates:Array},template:'\n    <section class="candidate-list-container">\n      <i v-if="searching" v-model="searching" class="loading"></i>\n      <div class="candidate-list">\n        <span v-if="!searching"\n              v-for="candidate in candidates"\n              v-bind:key="candidate"\n              class="candidate">{{ candidate }}</span>\n      </div>\n      <div class="more"></div>\n    </section>\n  '}),Vue.component("radical-selection",{props:{radical_selection:Array},template:'\n    <table>\n      <tbody>\n        <tr v-for="(radicals, stroke_num) in radical_selection" v-bind:key="stroke_num">\n          <th>{{ stroke_num }}</th>\n          <td>\n            <span v-for="(data, radical) in radicals"\n                  v-bind:key="radical"\n                  v-on:click="$emit(\'select-radical\', radical)"\n                  class="radical"\n                  v-bind:class="{\n                    selected:             data.selected,\n                    \'lookalike-selected\': data.lookalike_selected,\n                    unavailable:          !data.available,\n                  }"><i class="far fa-eye"></i>{{ data.display }}</span>\n          </td>\n        </tr>\n      </tbody>\n    </table>\n  '}),Vue.component("sort-option",{props:{sort:String,order:String,label:String},template:'\n    <div class="search_sortOption" v-on:click="$emit(\'click\', order)">\n      <input class="search_sortOptionInput"\n             type="radio"\n             name="sort"\n             v-bind:id="id"\n             v-bind:value="order"\n             v-model="sort">\n      <label class="search_sortOptionLabel" v-bind:for="id">{{ label }}</label>\n    </div>\n  ',computed:{id:function(){return"sort_"+this.order}}});const RADICALS_JSON_URL="https://rewhowe.github.io/kanji/public/json/radicals.json";let RADICAL_MAPPING=[];const COLLOCATIONS_JSON_URL="https://rewhowe.github.io/kanji/public/json/collocations.json";let COLLOCATIONS=[];const app=new Vue({el:"#app",data:{input:"",include_similar:!1,sort_options:SORT_OPTIONS,sort:"stroke",candidates:[],radical_selection:void 0,searching:!1,is_dropdown_open:!1},template:'\n    <div class="app">\n      <section class="search">\n        <div class="search_bar">\n          <div class="search_sort" v-bind:class="{ open: is_dropdown_open }">\n            <div class="search_sortTrigger" v-on:click="toggleDropdown"><span class="search_sortLabel">{{ sort_options[sort] }}</span></div>\n            <div class="search_sortOptions">\n              <sort-option v-for="(label, order) in sort_options"\n                           v-bind:key="order"\n                           v-bind:order="order"\n                           v-bind:label="label"\n                           v-bind:sort="sort"\n                           v-bind:class="{ selected: sort == order }"\n                           v-on:click="selectSort"></sort-option>\n            </div>\n          </div>\n          <input type="text" v-model="input" v-on:change="lookup" class="search_input">\n          <div class="search_includeSimilar">\n            <input id="include_similar" type="checkbox" v-model="include_similar" v-on:change="includeSimilar"　class="search_checkBox">\n            <label class="search_includeSimilarLabel" for="include_similar" v-bind:class="{ selected: include_similar }"><i class="far fa-eye"></i></label>\n          </div>\n        </div>\n\n        <candidate-list v-bind:candidates="candidates" v-bind:searching="searching"></candidate-list>\n\n        <radical-selection v-bind:radical_selection="radical_selection"\n                           v-on:select-radical="selectRadical"></radical-selection>\n      </section>\n\n      <about-section></about-section>\n\n      <footer class="footer">\n        <a class="about-link" href="https://github.com/rewhowe/kanji">GitHub</a>\n      </footer>\n    </div>\n  ',methods:{lookup:function(){const n=this;n.searching=!0,window.setTimeout(function(){const t=n.getRadicals(),e=n.getCandidates(t);n.updateSelection(),sortBy(e,n.sort,t=>n.candidates=t),n.searching=!1},1)},toggleDropdown:function(n){this.is_dropdown_open=!this.is_dropdown_open,n.stopPropagation()},selectSort:function(n){this.is_dropdown_open=!1,this.sortCandidates(n)},includeSimilar:function(){this.isIncludeSimilar=!this.isIncludeSimilar,this.lookup()},selectRadical:function(n){const t=this;t.searching=!0,window.setTimeout(function(){const e=RADICAL_MAPPING[n],i=t.radical_selection[e.strokes][n].selected;if(!t.radical_selection[e.strokes][n].available&&!i)return;const a=RADK_DISPLAY[n]||n;t.input=t.input.replace(new RegExp(a,"g"),""),i||(t.input=t.input+a),t.lookup()},1)},sortCandidates:function(n){const t=this;t.sort=n,t.searching=!0,sortBy(t.candidates,t.sort,n=>t.candidates=n),t.searching=!1},initialiseRadicalSelection:function(n){const t={};Object.keys(RADICAL_MAPPING).forEach(function(e){const i=RADICAL_MAPPING[e];t[i.strokes]||(t[i.strokes]={}),t[i.strokes][e]={display:RADK_DISPLAY[e]||e,selected:!1,lookalike_selected:!1,available:n}}),this.radical_selection=t},getRadicals:function(){const n=this;return n.input=n.input.replace(/[!！][^!！]/g,n=>ALTERNATE_FORMS[n[1]]||n[1]),[...n.input].map(function(t){return n.include_similar&&LOOKALIKES[t]||[RADK[t]||t]})},getCandidates:function(n){if(0==n.length)return[];const t=this;let e;return n.forEach(function(n){if(e&&0==e.length)return;const i=t.getKanjiWithRadical(n);e=void 0===e?i:intersect(e,i)}),[...new Set(e)]},getKanjiWithRadical:function(n){return n instanceof Array?n.map(this.getKanjiWithRadical).flat():RADICAL_MAPPING[n]?RADICAL_MAPPING[n].kanji:[]},updateSelection:function(){const n=this,t=[...n.input],e=n.getAvailableRadicals(t);n.initialiseRadicalSelection(void 0===e),t.forEach(function(t){n.setSelection(t,"selected"),n.include_similar&&LOOKALIKES[t]&&LOOKALIKES[t].forEach(t=>n.setSelection(t,"lookalike_selected"))}),void 0!==e&&e.forEach(function(t){n.setSelection(t,"available")})},setSelection:function(n,t){const e=RADICAL_MAPPING[n=RADK[n]||n];e&&(this.radical_selection[e.strokes][n][t]=!0)},getAvailableRadicals:function(n){const t=this,e=[];let i;return n.forEach(function(n){if(COLLOCATIONS[n=RADK[n]||n])if(e.push([n]),1==e.length)i=COLLOCATIONS[n];else if(2==e.length){const n=e.sort().join("");i=COLLOCATIONS[n]||[]}else{i=[];const a=[e[0],[n]].sort().join(""),s=COLLOCATIONS[a]||[],o=t.getCandidates(e);s.forEach(function(n){const t=RADICAL_MAPPING[n].kanji;intersect(o,t).length>0&&i.push(n)})}}),i}},beforeMount:function(){getJson(RADICALS_JSON_URL,function(n){RADICAL_MAPPING=n}),getJson(COLLOCATIONS_JSON_URL,function(n){COLLOCATIONS=n})},mounted:function(){const n=this;n.initialiseRadicalSelection(!0),document.addEventListener("click",function(){n.is_dropdown_open=!1})}});